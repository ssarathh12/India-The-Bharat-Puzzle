<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>India Geo-Puzzle Map</title>

<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Ensure Inter font is available or fall back to sans-serif */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
#map { height: 100%; width: 100%; border-radius: 0.75rem; }
.leaflet-grab { cursor: grab; }
.leaflet-dragging .leaflet-grab { cursor: grabbing; }

/* --- CORE STYLES: HIDING GAME ELEMENTS INITIALLY --- */

/* Use a class to manage visibility transition */
#map, header {
    opacity: 0; 
    visibility: hidden; /* Hide immediately until transition starts */
    pointer-events: none;
    transition: opacity 0.5s ease-in-out;
}

/* Class added to body on 'Start Puzzle' click */
.game-active #map,
.game-active header {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
}

/* Floating message animation keyframes */
@keyframes float {
    0% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
    100% { transform: translateY(0); }
}

.floating-message {
    animation: float 2.5s ease-in-out infinite;
}

/* Style to hide the overlay after animation */
#welcome-overlay.hidden-overlay {
    display: none; /* Hard hide after transition */
}

</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="bg-gray-100 p-4 sm:p-6 flex flex-col h-screen">

<header class="mb-4 p-3 bg-white shadow-xl rounded-xl border-b-4 border-indigo-500 flex flex-col sm:flex-row justify-between items-start sm:items-center">
<div>
<h1 class="text-3xl font-extrabold text-indigo-700">Bharat States-Puzzle</h1>
<p class="text-lg text-gray-700 font-semibold mt-1">Score: <span id="score" class="text-green-600">0 / 36</span></p>
</div>
<div class="flex items-center mt-2 sm:mt-0">
<p class="text-sm text-gray-600 mr-4" id="status-message">Initializing game data...</p>

<p class="text-xl font-bold text-red-600 mr-4" id="timer-display">00:00</p>

<button id="shuffle-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">Shuffle Pieces</button>
</div>
</header>

<div id="welcome-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-95 transition-opacity duration-500">
    <div class="bg-white p-8 sm:p-10 rounded-xl shadow-2xl max-w-lg text-center transform scale-100 transition-transform duration-500" id="welcome-box">
        <h2 class="text-4xl font-extrabold text-indigo-700 mb-4 animate-pulse">
            Hey
        </h2>
        <p class="text-xl text-gray-700 mb-6 font-semibold floating-message">
            Welcome! Drag and drop the regions back into the map of India to complete the puzzle.
        </p>
        <button id="start-puzzle-btn" class="px-8 py-3 bg-green-600 text-white text-lg font-bold rounded-xl shadow-lg hover:bg-green-700 transition transform hover:scale-105">
            Start Puzzle
        </button>
    </div>
</div>
<div id="map" class="flex-grow shadow-2xl"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const STATE_FILENAMES = ['ANDAMAN_and_NICOBAR.geojson', 'ANDHRA_PRADESH.geojson', 
'ARUNACHAL_PRADESH.geojson', 'ASSAM.geojson', 'BIHAR.geojson', 'CHANDIGARH.geojson', 
'CHHATTISGARH.geojson', 'DADRA_and_NAGAR_HAVELI_and_DAMAN_and_DIU.geojson', 'DELHI.geojson', 
'GOA.geojson', 'GUJARAT.geojson', 'HARYANA.geojson', 'HIMACHAL_PRADESH.geojson', 
'JAMMU_AND_KASHMIR.geojson', 'JHARKHAND.geojson', 'KARNATAKA.geojson', 'KERALA.geojson', 
'LADAKH.geojson', 'LAKSHADWEEP.geojson', 'MADHYA_PRADESH.geojson', 'MAHARASHTRA.geojson', 
'MANIPUR.geojson', 'MEGHALAYA.geojson', 'MIZORAM.geojson', 'NAGALAND.geojson', 'ODISHA.geojson', 
'PUDUCHERRY.geojson', 'PUNJAB.geojson', 'RAJASTHAN.geojson', 'SIKKIM.geojson', 'TAMIL_NADU.geojson', 
'TELANGANA.geojson', 'TRIPURA.geojson', 'UTTARAKHAND.geojson', 'UTTAR_PRADESH.geojson', 
'WEST_BENGAL.geojson'];

const TOTAL_PIECES = STATE_FILENAMES.length;
const SNAP_TOLERANCE_PIXELS = 20;
let gameState = { pieces: [], draggedPiece: null, score: 0 };

// --- TIMER VARIABLES ---
let timerInterval;
let timeElapsed = 0;
const timerDisplay = document.getElementById('timer-display');

// --- Timer Functions ---
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    const minStr = String(minutes).padStart(2, '0');
    const secStr = String(remainingSeconds).padStart(2, '0');
    return `${minStr}:${secStr}`;
}

function startTimer() {
    timeElapsed = 0;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timeElapsed++;
        timerDisplay.textContent = formatTime(timeElapsed);
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}

// --- Initialize map with Carto Voyager basemap ---
const map = L.map('map').setView([22.0, 78.0], 3);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.carto.com/">CARTO</a> &copy; OpenStreetMap contributors',
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);

// --- Styles ---
const geoJsonStyle = { color: "#ef4444", weight: 2, opacity: 0.8, fillColor: "#ef4444", fillOpacity: 0.5, className: "leaflet-grab" };
const snappedStyle = { color: "#10b981", weight: 3, opacity: 1.0, fillColor: "#10b981", fillOpacity: 0.8 };

// --- Core Helper Functions ---
function moveLayer(layer, latDiff, lngDiff) {
    const latlngs = layer.getLatLngs();
    const newLatLngs = latlngs.map(ringOrPolygon => {
        const applyDiff = coords => {
            if (coords.lat !== undefined && coords.lng !== undefined) return L.latLng(coords.lat + latDiff, coords.lng + lngDiff);
            return coords.map(applyDiff);
        };
        return applyDiff(ringOrPolygon);
    });
    layer.setLatLngs(newLatLngs);
}

// --- Drag Handlers (Unchanged) ---
function handleDragStart(e) {
    const piece = e.target.piece;
    if (piece.isSnapped) return;
    piece.layer.bringToFront();
    L.DomEvent.stop(e.originalEvent);
    map.dragging.disable();
    L.DomUtil.addClass(map.getContainer(), 'leaflet-dragging');
    gameState.draggedPiece = piece;
    piece.dragStartLatLng = e.latlng;
    piece.layer.setStyle({ opacity: 0.9, fillOpacity: 0.6, weight: 4 });
    map.on('mousemove', handleDrag);
    map.on('mouseup', handleDragEnd);
}

function handleDrag(e) {
    const piece = gameState.draggedPiece;
    if (!piece || !piece.dragStartLatLng) return;
    const latDiff = e.latlng.lat - piece.dragStartLatLng.lat;
    const lngDiff = e.latlng.lng - piece.dragStartLatLng.lng;
    moveLayer(piece.layer, latDiff, lngDiff);
    piece.dragStartLatLng = e.latlng;
}

function handleDragEnd() {
    const piece = gameState.draggedPiece;
    if (!piece) return;
    map.dragging.enable();
    L.DomUtil.removeClass(map.getContainer(), 'leaflet-dragging');
    map.off('mousemove', handleDrag);
    map.off('mouseup', handleDragEnd);
    checkSnap(piece);
    if (!piece.isSnapped) {
        piece.layer.setStyle(geoJsonStyle);
    }
    gameState.draggedPiece = null;
}

function checkSnap(piece) {
    const currentCenter = piece.layer.getBounds().getCenter();
    const currentPixel = map.latLngToContainerPoint(currentCenter);
    const targetPixel = map.latLngToContainerPoint(piece.targetCenter);
    const pixelDistance = currentPixel.distanceTo(targetPixel);

    if (pixelDistance <= SNAP_TOLERANCE_PIXELS) {
        const latCorrection = piece.targetCenter.lat - currentCenter.lat;
        const lngCorrection = piece.targetCenter.lng - currentCenter.lng;
        moveLayer(piece.layer, latCorrection, lngCorrection);

        piece.isSnapped = true;
        piece.layer.setStyle(snappedStyle);

        if (piece.layer._path) piece.layer._path.style.cursor = 'default';
        piece.layer.off('mousedown', handleDragStart);

        gameState.pieces.forEach(p => {
            if (!p.isSnapped) {
                p.layer.bringToFront();
            }
        });

        gameState.score++;
        document.getElementById('score').textContent = `${gameState.score} / ${TOTAL_PIECES}`;
        
        document.getElementById('status-message').textContent = `SUCCESS! ${piece.name} snapped into place!`;
        document.getElementById('status-message').className = 'text-green-600 font-bold';
        
        // --- TIMER STOP LOGIC ---
        if (gameState.score === TOTAL_PIECES) {
            stopTimer(); // Stop the timer when the last piece is snapped!
            document.getElementById('status-message').textContent = `PUZZLE COMPLETE! Final Time: ${formatTime(timeElapsed)}`;
            document.getElementById('status-message').className = 'text-green-800 font-extrabold';
        }
    }
}

function placeRandomlyOutsideIndia(layer) {
    const bounds = layer.getBounds();
    const currentCenter = bounds.getCenter();
    let newCenterLat, newCenterLng;

    const LAT_MIN = 8;
    const LAT_MAX = 37;

    if (Math.random() < 0.5) {
        newCenterLng = 60 + Math.random() * (67 - 60);
    } else {
        newCenterLng = 99 + Math.random() * (108 - 99);
    }

    newCenterLat = LAT_MIN + Math.random() * (LAT_MAX - LAT_MIN);

    const latCorrection = newCenterLat - currentCenter.lat;
    const lngCorrection = newCenterLng - currentCenter.lng;
    moveLayer(layer, latCorrection, lngCorrection);
}


// --- Main Load Function ---
async function loadAndInitializePuzzle() {
    const statusMessage = document.getElementById('status-message');
    statusMessage.textContent = `Loading ${TOTAL_PIECES} GeoJSON files...`;

    const fetchPromises = STATE_FILENAMES.map(fileName =>
        fetch(fileName)
            .then(response => {
                if (!response.ok) throw new Error(`Failed to load ${fileName}`);
                return response.json();
            })
            .then(data => ({ name: fileName.replace(".geojson","").replace(/_/g,' '), data }))
            .catch(err => { console.error("Error fetching file:", fileName, err); return null; })
    );

    const allGeoJsonData = (await Promise.all(fetchPromises)).filter(item => item !== null);
    if (allGeoJsonData.length === 0) {
        statusMessage.textContent = "FATAL ERROR: Could not load any GeoJSON data. Please ensure you are running this on a local web server.";
        statusMessage.className = 'text-red-600 font-bold';
        return;
    }

    document.getElementById('score').textContent = `0 / ${allGeoJsonData.length}`;

    allGeoJsonData.forEach(item => {
        const stateName = item.name;
        const originalGeoJsonData = item.data;

        const dummyLayer = L.geoJSON(originalGeoJsonData);
        const targetCenter = dummyLayer.getBounds().getCenter();
        dummyLayer.remove();

        const layer = L.geoJSON(originalGeoJsonData, {
            style: geoJsonStyle,
            onEachFeature: (feature, layer) => {
                const piece = {
                    name: stateName,
                    layer,
                    targetCenter,
                    isSnapped: false,
                    dragStartLatLng: null
                };
                layer.piece = piece;
                layer.on('mousedown', handleDragStart);

                placeRandomlyOutsideIndia(layer);

                gameState.pieces.push(piece);
            }
        }).addTo(map);
    });

    statusMessage.textContent = `Game loaded with ${allGeoJsonData.length} regions. Drag the pieces back to India!`;
    statusMessage.className = 'text-indigo-700 font-medium';
}

// --- Shuffle button ---
document.getElementById('shuffle-btn').addEventListener('click', () => {
    // Prevent shuffling if the puzzle is already complete
    if (gameState.score === TOTAL_PIECES) return; 

    gameState.pieces.forEach(piece => {
        if (!piece.isSnapped) {
            placeRandomlyOutsideIndia(piece.layer);
            piece.layer.setStyle(geoJsonStyle);
            piece.layer.on('mousedown', handleDragStart);
            if (piece.layer._path) piece.layer._path.style.cursor = 'grab';
            piece.layer.bringToFront();
        }
    });
    document.getElementById('status-message').textContent = "Pieces shuffled to non-target regions!";
    document.getElementById('status-message').className = 'text-indigo-700 font-medium';
});

// --- START BUTTON LOGIC (FIXED FOR NO FLASHING & TIMER START) ---
document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('start-puzzle-btn');
    const welcomeOverlay = document.getElementById('welcome-overlay');
    const body = document.body;
    const welcomeBox = document.getElementById('welcome-box');

    // Load data immediately in the background while the user sees the welcome screen
    loadAndInitializePuzzle();

    startButton.addEventListener('click', () => {
        // 1. Start the Timer right when the user clicks
        startTimer();

        // 2. Animate the welcome box out
        welcomeBox.style.transform = 'scale(1.1)';
        welcomeBox.style.opacity = '0';
        
        // 3. Simultaneously trigger the game elements to fade in
        // This relies on the CSS transition in the <style> block
        body.classList.add('game-active');

        // 4. Hide the overlay completely after the transition time (500ms for opacity)
        setTimeout(() => {
            welcomeOverlay.classList.add('hidden-overlay');
            
            // 5. Force Leaflet to redraw itself once visible (CRITICAL STEP)
            map.invalidateSize(); 

        }, 500); // 500ms matches the CSS transition duration
    });
});

</script>
</body>

</html>

